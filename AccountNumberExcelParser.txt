package com.syf.payfone.service.parser.impl;

import com.syf.payfone.model.AccountNumberRecord;
import com.syf.payfone.service.parser.ExcelParser;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.springframework.stereotype.Component;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

@Component
public class AccountNumberExcelParser implements ExcelParser<AccountNumberRecord> {

    @Override
    public List<AccountNumberRecord> parse(MultipartFile file) throws IOException {
        List<AccountNumberRecord> records = new ArrayList<>();
        
        try (Workbook workbook = new XSSFWorkbook(file.getInputStream())) {
            Sheet sheet = workbook.getSheetAt(0);
            
            // Skip header row
            for (int i = 1; i <= sheet.getLastRowNum(); i++) {
                Row row = sheet.getRow(i);
                if (row == null) continue;
                
                AccountNumberRecord record = AccountNumberRecord.builder()
                    .accountNumber(getCellValue(row, 0))
                    .phoneNumber(getCellValue(row, 1))
                    .lineType(getDefaultValue(getCellValue(row, 2), "Mobile"))
                    .confirmed(getDefaultValue(getCellValue(row, 3), "True"))
                    .ssn(getCellValue(row, 4))
                    .dob(getCellValue(row, 5))
                    .channelId(getDefaultValue(getCellValue(row, 6), "Default"))
                    .build();
                
                records.add(record);
            }
        }
        
        return records;
    }
    
    private String getCellValue(Row row, int cellIndex) {
        Cell cell = row.getCell(cellIndex);
        if (cell == null) return null;
        
        return switch (cell.getCellType()) {
            case STRING -> cell.getStringCellValue().trim();
            case NUMERIC -> {
                if (DateUtil.isCellDateFormatted(cell)) {
                    yield cell.getLocalDateTimeCellValue().toLocalDate().toString();
                } else {
                    // Format as integer string if it's a whole number
                    double numValue = cell.getNumericCellValue();
                    if (numValue == Math.floor(numValue)) {
                        yield String.valueOf((long) numValue);
                    }
                    yield String.valueOf(numValue);
                }
            }
            case BOOLEAN -> String.valueOf(cell.getBooleanCellValue());
            default -> null;
        };
    }
    
    private String getDefaultValue(String value, String defaultValue) {
        return (value == null || value.trim().isEmpty()) ? defaultValue : value;
    }
}