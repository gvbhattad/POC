package com.syf.payfone.service;

import com.syf.payfone.model.ExcelRecord;
import com.syf.payfone.service.parser.ExcelParser;
import com.syf.payfone.service.processor.RecordProcessor;
import com.syf.payfone.service.writer.ExcelWriter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.util.List;

/**
 * Generic Excel Processing Service
 * Follows Open/Closed Principle - open for extension, closed for modification
 * 
 * @param <T> Type of ExcelRecord to process
 */
@Service
public class ExcelProcessingService<T extends ExcelRecord> {
    
    private static final Logger log = LoggerFactory.getLogger(ExcelProcessingService.class);
    
    /**
     * Process Excel file with custom parser, processor, and writer
     * Demonstrates Dependency Inversion Principle - depends on abstractions, not concretions
     */
    public ByteArrayOutputStream processExcel(
            MultipartFile file,
            ExcelParser<T> parser,
            RecordProcessor<T> processor,
            ExcelWriter<T> writer) throws IOException {
        
        log.info("Starting Excel processing for file: {}", file.getOriginalFilename());
        
        // Parse Excel file
        List<T> records = parser.parse(file);
        log.info("Parsed {} records from Excel", records.size());
        
        // Process each record
        records.forEach(record -> {
            try {
                processor.process(record);
            } catch (Exception e) {
                log.error("Error processing record: {}", record.getIdentifier(), e);
                record.setStatus("Error: " + e.getMessage());
            }
        });
        
        log.info("Completed processing all records");
        
        // Write updated Excel
        ByteArrayOutputStream output = writer.write(records);
        log.info("Generated output Excel with {} bytes", output.size());
        
        return output;
    }
}